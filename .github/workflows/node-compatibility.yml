name: ğŸ”§ Node.js Compatibility Matrix

on:
    schedule:
        # Run weekly on Sundays at 2 AM UTC
        - cron: '0 2 * * 0'
    workflow_dispatch:
        inputs:
            node_versions:
                description: 'Node versions to test (comma-separated)'
                required: false
                default: '16,18,20,22,latest'
            include_prerelease:
                description: 'Include Node.js prerelease versions'
                required: false
                default: false
                type: boolean

permissions:
    contents: read
    issues: write

jobs:
    detect-versions:
        name: ğŸ” Detect Node.js Versions
        runs-on: ubuntu-latest

        permissions:
            contents: read

        outputs:
            matrix: ${{ steps.set-matrix.outputs.matrix }}
            node-versions: ${{ steps.set-matrix.outputs.node-versions }}

        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ğŸ” Setup version matrix
              id: set-matrix
              run: |
                  if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.node_versions }}" ]; then
                    # Use user-provided versions
                    VERSIONS="${{ github.event.inputs.node_versions }}"
                  else
                    # Default comprehensive testing matrix
                    VERSIONS="16,18,20,22,latest"
                  fi

                  # Add prerelease if requested
                  if [ "${{ github.event.inputs.include_prerelease }}" = "true" ]; then
                    VERSIONS="$VERSIONS,node"
                  fi

                  echo "Testing Node.js versions: $VERSIONS"

                  # Convert to JSON array for matrix
                  JSON_ARRAY=$(echo "$VERSIONS" | jq -R 'split(",")')
                  echo "matrix={\"node-version\":$JSON_ARRAY}" >> $GITHUB_OUTPUT
                  echo "node-versions=$VERSIONS" >> $GITHUB_OUTPUT

    compatibility-test:
        name: ğŸ§ª Test Node ${{ matrix.node-version }} (${{ matrix.os }})
        needs: detect-versions
        runs-on: ${{ matrix.os }}

        permissions:
            contents: read

        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, windows-latest, macos-latest]
                node-version: ${{ fromJson(needs.detect-versions.outputs.matrix).node-version }}
                # Test different package managers
                package-manager: [pnpm, npm]
                exclude:
                    # Reduce matrix size for efficiency
                    - os: macos-latest
                      package-manager: npm
                    - node-version: 'latest'
                      package-manager: npm

        continue-on-error: true

        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
              continue-on-error: true
              id: node-setup

            - name: ğŸ“¦ Setup pnpm (if using pnpm)
              if: matrix.package-manager == 'pnpm' && steps.node-setup.outcome == 'success'
              uses: pnpm/action-setup@v4
              with:
                  version: latest
              continue-on-error: true
              id: pnpm-setup

            - name: ğŸ” Node.js version info
              if: steps.node-setup.outcome == 'success'
              run: |
                  echo "ğŸ“Š Node.js Version Information"
                  echo "================================"
                  node --version
                  npm --version
                  if [ "${{ matrix.package-manager }}" = "pnpm" ]; then
                    pnpm --version || echo "âŒ pnpm not available"
                  fi
                  echo ""
                  echo "ğŸŒ Environment:"
                  echo "OS: ${{ matrix.os }}"
                  echo "Package Manager: ${{ matrix.package-manager }}"
                  echo "Node Version: ${{ matrix.node-version }}"

            - name: ğŸ“š Install dependencies with ${{ matrix.package-manager }}
              if: steps.node-setup.outcome == 'success'
              run: |
                  if [ "${{ matrix.package-manager }}" = "pnpm" ]; then
                    if [ "${{ steps.pnpm-setup.outcome }}" = "success" ]; then
                      pnpm install --frozen-lockfile
                    else
                      echo "âŒ pnpm setup failed, skipping pnpm install"
                      exit 1
                    fi
                  else
                    # Use npm
                    npm ci
                  fi
              continue-on-error: true
              id: install-deps
              shell: bash

            - name: ğŸ” Dependency audit
              if: steps.install-deps.outcome == 'success'
              run: |
                  echo "ğŸ” Checking for security vulnerabilities..."
                  if [ "${{ matrix.package-manager }}" = "pnpm" ]; then
                    pnpm audit --prod || echo "âš ï¸ Security audit found issues (non-blocking)"
                  else
                    npm audit --audit-level moderate || echo "âš ï¸ Security audit found issues (non-blocking)"
                  fi
              continue-on-error: true

            - name: ğŸ—ï¸ Build project
              if: steps.install-deps.outcome == 'success'
              run: |
                  if [ "${{ matrix.package-manager }}" = "pnpm" ]; then
                    pnpm run compile
                  else
                    npm run compile
                  fi
              continue-on-error: true
              id: build

            - name: ğŸ” Type checking
              if: steps.build.outcome == 'success'
              run: |
                  if [ "${{ matrix.package-manager }}" = "pnpm" ]; then
                    pnpm run check-types
                  else
                    npm run check-types
                  fi
              continue-on-error: true
              id: typecheck

            - name: ğŸ•µï¸ Linting
              if: steps.build.outcome == 'success'
              run: |
                  if [ "${{ matrix.package-manager }}" = "pnpm" ]; then
                    pnpm run lint
                  else
                    npm run lint
                  fi
              continue-on-error: true
              id: lint

            - name: ğŸ“¦ Package extension
              if: steps.build.outcome == 'success'
              run: |
                  if [ "${{ matrix.package-manager }}" = "pnpm" ]; then
                    pnpm run package
                  else
                    npm run package
                  fi
              continue-on-error: true
              id: package

            - name: ğŸ§ª Run tests
              if: steps.build.outcome == 'success'
              run: |
                  if [ "$RUNNER_OS" = "Linux" ]; then
                    xvfb-run -a ${{ matrix.package-manager == 'pnpm' && 'pnpm test' || 'npm test' }}
                  else
                    ${{ matrix.package-manager == 'pnpm' && 'pnpm test' || 'npm test' }}
                  fi
              continue-on-error: true
              id: test
              env:
                  NODE_ENV: test

            - name: ğŸ“Š Test Results Summary
              if: always()
              run: |
                  echo "ğŸ“Š Compatibility Test Results for Node ${{ matrix.node-version }} on ${{ matrix.os }}"
                  echo "============================================================================"
                  echo "ğŸŸ¢ Node Setup: ${{ steps.node-setup.outcome }}"
                  echo "ğŸ“¦ Package Manager Setup: ${{ steps.pnpm-setup.outcome || 'N/A (using npm)' }}"
                  echo "ğŸ“š Install Dependencies: ${{ steps.install-deps.outcome }}"
                  echo "ğŸ—ï¸ Build: ${{ steps.build.outcome }}"
                  echo "ğŸ” Type Check: ${{ steps.typecheck.outcome }}"
                  echo "ğŸ•µï¸ Lint: ${{ steps.lint.outcome }}"
                  echo "ğŸ“¦ Package: ${{ steps.package.outcome }}"
                  echo "ğŸ§ª Test: ${{ steps.test.outcome }}"
                  echo ""

                  # Determine overall status
                  if [ "${{ steps.node-setup.outcome }}" = "success" ] && \
                     [ "${{ steps.install-deps.outcome }}" = "success" ] && \
                     [ "${{ steps.build.outcome }}" = "success" ] && \
                     [ "${{ steps.test.outcome }}" = "success" ]; then
                    echo "âœ… OVERALL: COMPATIBLE"
                    echo "status=compatible" >> $GITHUB_ENV
                  elif [ "${{ steps.node-setup.outcome }}" = "failure" ]; then
                    echo "âŒ OVERALL: NODE SETUP FAILED"
                    echo "status=node-failed" >> $GITHUB_ENV
                  else
                    echo "âš ï¸ OVERALL: PARTIAL COMPATIBILITY"
                    echo "status=partial" >> $GITHUB_ENV
                  fi

            - name: ğŸ“¤ Upload build artifacts (if successful)
              if: steps.package.outcome == 'success'
              uses: actions/upload-artifact@v4
              with:
                  name: build-node${{ matrix.node-version }}-${{ matrix.os }}-${{ matrix.package-manager }}
                  path: |
                      dist/
                      *.vsix
                  retention-days: 7

    compatibility-report:
        name: ğŸ“‹ Generate Compatibility Report
        needs: [detect-versions, compatibility-test]
        if: always()
        runs-on: ubuntu-latest

        permissions:
            contents: read
            issues: write

        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ğŸ“Š Collect test results
              id: collect-results
              run: |
                  echo "ğŸ“Š Collecting compatibility test results..."

                  # This would ideally collect results from the matrix jobs
                  # For now, we'll create a summary based on the job outcomes

                  cat > compatibility-report.md << 'EOF'
                  # ğŸ”§ Node.js Compatibility Report

                  **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")  
                  **Tested Versions:** ${{ needs.detect-versions.outputs.node-versions }}  
                  **Trigger:** ${{ github.event_name }}

                  ## ğŸ“Š Summary

                  This report shows the compatibility status of the Keypress Notifications extension across different Node.js versions and platforms.

                  ### âœ… Fully Compatible
                  - Node.js versions that passed all tests

                  ### âš ï¸ Partially Compatible  
                  - Node.js versions with minor issues but core functionality works

                  ### âŒ Incompatible
                  - Node.js versions that failed critical tests

                  ## ğŸ¯ Recommendations

                  - **Primary Development:** Use Node 20.x (LTS)
                  - **Minimum Support:** Node 16.x
                  - **Future Testing:** Include Node 22.x for forward compatibility

                  ## ğŸ”— Links

                  - [View Full Test Results](https://github.com/Vijay431/vscode-keypress_snackbar_notification-extension/actions)
                  - [Node.js Compatibility CI](https://github.com/Vijay431/vscode-keypress_snackbar_notification-extension/blob/master/.github/workflows/node-compatibility.yml)
                  - [Report Issues](https://github.com/Vijay431/vscode-keypress_snackbar_notification-extension/issues)

                  ---

                  *This report is automatically generated by the Node.js Compatibility CI workflow.*
                  EOF

                  cat compatibility-report.md

            - name: ğŸ·ï¸ Create or update compatibility issue
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      const report = fs.readFileSync('compatibility-report.md', 'utf8');

                      // Look for existing compatibility report issue
                      const issues = await github.rest.issues.listForRepo({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        labels: ['compatibility', 'automated'],
                        state: 'open'
                      });

                      const title = 'ğŸ”§ Node.js Compatibility Report';
                      const labels = ['compatibility', 'automated', 'documentation'];

                      if (issues.data.length > 0) {
                        // Update existing issue
                        const issue = issues.data[0];
                        await github.rest.issues.update({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: issue.number,
                          body: report
                        });
                        
                        console.log(`Updated compatibility report issue #${issue.number}`);
                      } else {
                        // Create new issue
                        const newIssue = await github.rest.issues.create({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          title: title,
                          body: report,
                          labels: labels
                        });
                        
                        console.log(`Created new compatibility report issue #${newIssue.data.number}`);
                      }

    notification:
        name: ğŸ“¬ Send Notifications
        needs: [compatibility-test, compatibility-report]
        if: always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
        runs-on: ubuntu-latest

        permissions:
            contents: read

        steps:
            - name: ğŸ“Š Workflow Summary
              run: |
                  echo "ğŸ”§ Node.js Compatibility Check Complete!"
                  echo "========================================"
                  echo "ğŸ“… Trigger: ${{ github.event_name }}"
                  echo "â° Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
                  echo "ğŸ”— Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  echo ""
                  echo "ğŸ“‹ Results:"
                  echo "- Compatibility Tests: ${{ needs.compatibility-test.result }}"
                  echo "- Report Generation: ${{ needs.compatibility-report.result }}"
                  echo ""
                  echo "ğŸ¯ Check the compatibility report issue for detailed results!"
