name: ğŸš€ CI/CD Pipeline

on:
    push:
        branches: ['**']

permissions:
    contents: write
    pull-requests: read
    security-events: write

jobs:
    test:
        name: ğŸ”§ Test (Node ${{ matrix.node-version }} on ${{ matrix.os }})
        runs-on: ${{ matrix.os }}

        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, windows-latest, macos-latest]
                node-version: ['16', '18', '20', '22', '24']

        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ğŸ“¦ Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: latest

            - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: 'pnpm'

            - name: ğŸ“± Setup VS Code Test Environment
              run: |
                  if [ "$RUNNER_OS" == "Linux" ]; then
                    sudo apt-get update
                    sudo apt-get install -y xvfb
                  fi
              shell: bash

            - name: ğŸ“š Install dependencies
              run: pnpm install --frozen-lockfile

            - name: ğŸ—ï¸ Build project
              run: pnpm run compile

            - name: ğŸ” Type check
              run: pnpm run check-types

            - name: ğŸ•µï¸ Lint code
              run: pnpm run lint

            - name: ğŸ¨ Check formatting
              run: pnpm run format --check

            - name: ğŸ§ª Run tests
              run: |
                  if [ "$RUNNER_OS" == "Linux" ]; then
                    xvfb-run -a pnpm test
                  else
                    pnpm test
                  fi
              shell: bash
              env:
                  NODE_ENV: test

    security:
        name: ğŸ”’ Security Scan
        needs: test
        runs-on: ubuntu-latest

        permissions:
            contents: read
            security-events: write

        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ğŸ“¦ Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: latest

            - name: ğŸŸ¢ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'pnpm'

            - name: ğŸ“š Install dependencies
              run: pnpm install --frozen-lockfile

            - name: ğŸ” Run security audit
              run: pnpm audit --prod
              continue-on-error: true

            - name: ğŸ•µï¸ Run npm audit
              run: npm audit --audit-level moderate
              continue-on-error: true

    compatibility:
        name: ğŸ”§ VS Code Compatibility
        needs: test
        runs-on: ubuntu-latest

        permissions:
            contents: read

        strategy:
            matrix:
                vscode-version: ['1.90.0', '1.95.0', 'stable', 'insiders']

        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ğŸ“¦ Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: latest

            - name: ğŸŸ¢ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'pnpm'

            - name: ğŸ“š Install dependencies
              run: pnpm install --frozen-lockfile

            - name: ğŸ—ï¸ Build for VS Code ${{ matrix.vscode-version }}
              run: pnpm run compile

            - name: ğŸ§ª Test with VS Code ${{ matrix.vscode-version }}
              run: |
                  if [ "${{ matrix.vscode-version }}" != "stable" ] && [ "${{ matrix.vscode-version }}" != "insiders" ]; then
                    export VSCODE_VERSION=${{ matrix.vscode-version }}
                  fi
                  xvfb-run -a pnpm test
              env:
                  VSCODE_VERSION: ${{ matrix.vscode-version }}

    deploy:
        name: ğŸš€ Deploy to Marketplace
        needs: [security, compatibility]
        if: github.ref == 'refs/heads/master'
        runs-on: ubuntu-latest

        environment: marketplace

        permissions:
            contents: read

        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ğŸ“¦ Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: latest

            - name: ğŸŸ¢ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'pnpm'

            - name: ğŸ“š Install dependencies
              run: pnpm install --frozen-lockfile

            - name: ğŸ—ï¸ Build for production
              run: pnpm run package

            - name: ğŸ“¤ Package extension
              run: |
                  npx vsce package --no-dependencies
                  ls -la *.vsix

            - name: ğŸŒ Publish to VS Code Marketplace
              uses: HaaLeo/publish-vscode-extension@v1
              with:
                  pat: ${{ secrets.VS_MARKETPLACE_TOKEN }}
                  registryUrl: https://marketplace.visualstudio.com

    summary:
        name: ğŸ“Š CI/CD Summary
        if: always()
        needs: [test, security, compatibility, deploy]
        runs-on: ubuntu-latest

        permissions:
            contents: read

        steps:
            - name: ğŸ“‹ Check all jobs status
              run: |
                  echo "ğŸ§ª Test Results: ${{ needs.test.result }}"
                  echo "ğŸ”’ Security Results: ${{ needs.security.result }}"
                  echo "ğŸ”§ Compatibility Results: ${{ needs.compatibility.result }}"
                  echo "ğŸš€ Deploy Results: ${{ needs.deploy.result || 'skipped (not master branch)' }}"
                  echo ""

                  if [ "${{ needs.test.result }}" != "success" ]; then
                    echo "âŒ CI/CD Pipeline failed!"
                    exit 1
                  elif [ "${{ github.ref }}" == "refs/heads/master" ] && [ "${{ needs.deploy.result }}" != "success" ]; then
                    echo "âŒ Deployment failed!"
                    exit 1
                  else
                    echo "âœ… All checks passed! ğŸ‰"
                    if [ "${{ github.ref }}" == "refs/heads/master" ]; then
                      echo "ğŸš€ Successfully deployed to marketplace!"
                    fi
                  fi